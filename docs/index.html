<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#4F46E5">

    <title>Daily Lesson Plans</title>

    <!-- Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = { darkMode: 'class' };
        // Apply dark mode immediately to prevent flash
        if (localStorage.getItem('darkMode') === 'true' ||
            (!localStorage.getItem('darkMode') && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        }
    </script>

    <!-- Alpine.js via CDN -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

    <!-- Marked.js for Markdown Rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- TinyMusic for melody playback -->
    <script src="https://cdn.jsdelivr.net/npm/tinymusic@1.0.0/dist/TinyMusic.js"></script>

    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">

    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üìö</text></svg>">

    <style>
        /* Custom touch feedback */
        .btn-touch:active {
            transform: scale(0.98);
        }

        /* Smooth transitions */
        * {
            transition: background-color 0.15s ease;
        }

        /* Lesson plan content styling */
        .lesson-content {
            line-height: 1.7;
        }

        .lesson-content h1 {
            font-size: 1.875rem;
            font-weight: bold;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
        }

        .lesson-content h2 {
            font-size: 1.5rem;
            font-weight: bold;
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
            color: #1f2937;
        }

        .dark .lesson-content h2 {
            color: #e5e7eb;
        }

        .lesson-content h3 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
            color: #374151;
        }

        .dark .lesson-content h3 {
            color: #d1d5db;
        }

        .lesson-content p {
            margin-bottom: 0.75rem;
        }

        .lesson-content ul, .lesson-content ol {
            margin-left: 1.5rem;
            margin-bottom: 0.75rem;
        }

        .lesson-content li {
            margin-bottom: 0.25rem;
        }

        .lesson-content strong {
            font-weight: 600;
            color: #111827;
        }

        .dark .lesson-content strong {
            color: #f3f4f6;
        }

        .lesson-content code {
            background-color: #f3f4f6;
            padding: 0.125rem 0.375rem;
            border-radius: 0.25rem;
            font-size: 0.875rem;
        }

        .dark .lesson-content code {
            background-color: #374151;
            color: #e5e7eb;
        }

        .lesson-content blockquote {
            border-left: 4px solid #e5e7eb;
            padding-left: 1rem;
            margin: 1rem 0;
            color: #6b7280;
        }

        .dark .lesson-content blockquote {
            border-left-color: #4b5563;
            color: #9ca3af;
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 dark:text-gray-100 min-h-screen" x-data="lessonPlanApp()" x-init="init()">

    <!-- Header -->
    <header class="bg-indigo-600 dark:bg-indigo-900 text-white shadow-lg sticky top-0 z-10">
        <div class="max-w-4xl mx-auto px-4 py-4">
            <div class="flex justify-between items-center">
                <h1 class="text-2xl font-bold">üìö Daily Lesson Plans</h1>
                <div class="flex items-center gap-2">
                <button
                    @click="toggleDarkMode()"
                    class="p-2 rounded-lg hover:bg-indigo-700 active:bg-indigo-800"
                    title="Toggle dark mode">
                    <svg x-show="!darkMode" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
                    </svg>
                    <svg x-show="darkMode" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="display:none;">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>
                    </svg>
                </button>
                <button
                    @click="showMenu = !showMenu"
                    class="p-2 rounded-lg hover:bg-indigo-700 active:bg-indigo-800">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                    </svg>
                </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Menu Overlay -->
    <div x-show="showMenu"
         x-transition:enter="transition ease-out duration-200"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-150"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         @click.self="showMenu = false"
         class="fixed inset-0 bg-black bg-opacity-50 z-20"
         style="display: none;">

        <div class="fixed top-0 right-0 h-full w-80 bg-white dark:bg-gray-800 shadow-xl p-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold">Menu</h2>
                <button @click="showMenu = false" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>

            <div class="space-y-3">
                <button @click="exportData(); showMenu = false"
                        class="w-full px-4 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 active:bg-blue-700 btn-touch text-left">
                    üì• Export Data
                </button>

                <button @click="$refs.importFile.click(); showMenu = false"
                        class="w-full px-4 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 active:bg-green-700 btn-touch text-left">
                    üì§ Import Data
                </button>

                <button @click="viewHistory(); showMenu = false"
                        class="w-full px-4 py-3 bg-purple-500 text-white rounded-lg hover:bg-purple-600 active:bg-purple-700 btn-touch text-left">
                    üìú View History
                </button>

                <button @click="viewDevelopment(); showMenu = false"
                        class="w-full px-4 py-3 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 active:bg-yellow-700 btn-touch text-left">
                    üîß Development Queue
                </button>

                <button @click="randomizeAllQueues(); showMenu = false"
                        class="w-full px-4 py-3 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 active:bg-indigo-700 btn-touch text-left">
                    üé≤ Randomize All Queues
                </button>

                <hr class="my-4">

                <button @click="resetAllData(); showMenu = false"
                        class="w-full px-4 py-3 bg-red-500 text-white rounded-lg hover:bg-red-600 active:bg-red-700 btn-touch text-left">
                    üîÑ Reset All Data
                </button>
            </div>

            <div class="mt-8 pt-8 border-t dark:border-gray-700 text-sm text-gray-600 dark:text-gray-400">
                <p>Completed Today: <strong x-text="completedToday.length"></strong></p>
                <p>Total Completed: <strong x-text="data.completed.length"></strong></p>
            </div>
        </div>
    </div>

    <!-- Hidden file input for import -->
    <input type="file" x-ref="importFile" @change="importData($event)" accept=".json" class="hidden">

    <!-- Main Content -->
    <main class="max-w-4xl mx-auto px-4 py-6 pb-20">

        <!-- Lesson Plan View -->
        <div x-show="currentView === 'lesson'" x-transition style="display: none;">
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 mb-6">
                <!-- Back Button -->
                <button @click="closeLessonPlan()"
                        class="mb-4 px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 active:bg-gray-400 btn-touch flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                    </svg>
                    Back to Queues
                </button>

                <!-- Play Song Button (only for songs queue) - at top -->
                <template x-if="currentLessonTopic && currentLessonTopic.queueName === 'songs' && !lessonLoading">
                    <button @click="playSongMelody()"
                            class="w-full mb-4 px-4 py-4 bg-orange-500 text-white rounded-lg hover:bg-orange-600 active:bg-orange-700 btn-touch font-medium text-lg flex items-center justify-center">
                        <span x-show="!isPlaying">üéµ Play Melody</span>
                        <span x-show="isPlaying">üîä Playing... (tap to stop)</span>
                    </button>
                </template>

                <!-- Loading State -->
                <div x-show="lessonLoading" class="text-center py-12">
                    <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600"></div>
                    <p class="mt-4 text-gray-600 dark:text-gray-400">Loading lesson plan...</p>
                </div>

                <!-- Error State -->
                <div x-show="lessonError" class="bg-red-50 dark:bg-red-900/30 border border-red-200 dark:border-red-800 rounded-lg p-4 mb-4">
                    <p class="text-red-800 dark:text-red-300" x-text="lessonError"></p>
                </div>

                <!-- Lesson Content -->
                <div x-show="!lessonLoading && !lessonError" class="lesson-content" x-html="lessonContent"></div>

                <!-- Action Buttons -->
                <div x-show="!lessonLoading" class="mt-6 space-y-3">
                    <!-- Mark Complete Button -->
                    <button @click="markTopicComplete()"
                            class="w-full px-4 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 active:bg-green-800 btn-touch font-medium">
                        ‚úì Mark Complete & Return
                    </button>

                    <!-- Skip to End Button -->
                    <button @click="skipTopicFromLesson()"
                            class="w-full px-4 py-3 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 active:bg-yellow-700 btn-touch font-medium">
                        ‚è≠Ô∏è Skip to End of Queue
                    </button>

                    <!-- Back Button (no queue modification) -->
                    <button @click="closeLessonPlan()"
                            class="w-full px-4 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600 active:bg-gray-700 btn-touch font-medium">
                        ‚Üê Back to Queues (Don't Change Queue)
                    </button>
                </div>
            </div>
        </div>

        <!-- Queue Selection View -->
        <div x-show="currentView === 'queues'" style="display: none;">

        <!-- Queue Cards -->
        <div class="space-y-6">

            <!-- Knowledge, Skills & Culture Queue (Combined) -->
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-blue-600">üß† Knowledge, Skills & Culture</h2>
                    <span class="text-sm text-gray-500 dark:text-gray-400" x-text="getQueuePosition('knowledge')"></span>
                </div>

                <template x-if="getCurrentTopic('knowledge')">
                    <div>
                        <p class="text-lg font-medium mb-2" x-text="getCurrentTopic('knowledge').name"></p>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mb-4" x-text="getCurrentTopic('knowledge').category"></p>

                        <div class="grid grid-cols-3 gap-2">
                            <button @click="selectTopic('knowledge')"
                                    class="py-3 px-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 active:bg-blue-700 btn-touch text-sm font-medium">
                                ‚úì Select
                            </button>
                            <button @click="skipTopic('knowledge')"
                                    class="py-3 px-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 active:bg-gray-400 btn-touch text-sm">
                                ‚è≠Ô∏è Skip
                            </button>
                            <button @click="flagForDevelopment('knowledge')"
                                    class="py-3 px-2 bg-yellow-100 dark:bg-yellow-900 text-yellow-700 dark:text-yellow-300 rounded-lg hover:bg-yellow-200 dark:hover:bg-yellow-800 active:bg-yellow-300 btn-touch text-sm">
                                üîß Fix
                            </button>
                        </div>
                    </div>
                </template>

                <template x-if="!getCurrentTopic('knowledge')">
                    <p class="text-gray-500 italic">Queue empty - refilling...</p>
                </template>
            </div>

            <!-- Physical Activities Queue -->
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-green-600">‚öΩ Physical Activities</h2>
                    <span class="text-sm text-gray-500 dark:text-gray-400" x-text="getQueuePosition('physical')"></span>
                </div>

                <template x-if="getCurrentTopic('physical')">
                    <div>
                        <p class="text-lg font-medium mb-2" x-text="getCurrentTopic('physical').name"></p>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mb-4" x-text="getCurrentTopic('physical').category"></p>

                        <div class="grid grid-cols-3 gap-2">
                            <button @click="selectTopic('physical')"
                                    class="py-3 px-2 bg-green-500 text-white rounded-lg hover:bg-green-600 active:bg-green-700 btn-touch text-sm font-medium">
                                ‚úì Select
                            </button>
                            <button @click="skipTopic('physical')"
                                    class="py-3 px-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 active:bg-gray-400 btn-touch text-sm">
                                ‚è≠Ô∏è Skip
                            </button>
                            <button @click="flagForDevelopment('physical')"
                                    class="py-3 px-2 bg-yellow-100 dark:bg-yellow-900 text-yellow-700 dark:text-yellow-300 rounded-lg hover:bg-yellow-200 dark:hover:bg-yellow-800 active:bg-yellow-300 btn-touch text-sm">
                                üîß Fix
                            </button>
                        </div>
                    </div>
                </template>

                <template x-if="!getCurrentTopic('physical')">
                    <p class="text-gray-500 italic">Queue empty - refilling...</p>
                </template>
            </div>

            <!-- Songs Queue -->
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-orange-600">üéµ Songs</h2>
                    <span class="text-sm text-gray-500 dark:text-gray-400" x-text="getQueuePosition('songs')"></span>
                </div>

                <template x-if="getCurrentTopic('songs')">
                    <div>
                        <p class="text-lg font-medium mb-2" x-text="getCurrentTopic('songs').name"></p>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mb-4" x-text="getCurrentTopic('songs').category"></p>

                        <div class="grid grid-cols-3 gap-2">
                            <button @click="selectTopic('songs')"
                                    class="py-3 px-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 active:bg-orange-700 btn-touch text-sm font-medium">
                                ‚úì Select
                            </button>
                            <button @click="skipTopic('songs')"
                                    class="py-3 px-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 active:bg-gray-400 btn-touch text-sm">
                                ‚è≠Ô∏è Skip
                            </button>
                            <button @click="flagForDevelopment('songs')"
                                    class="py-3 px-2 bg-yellow-100 dark:bg-yellow-900 text-yellow-700 dark:text-yellow-300 rounded-lg hover:bg-yellow-200 dark:hover:bg-yellow-800 active:bg-yellow-300 btn-touch text-sm">
                                üîß Fix
                            </button>
                        </div>
                    </div>
                </template>

                <template x-if="!getCurrentTopic('songs')">
                    <p class="text-gray-500 italic">Queue empty - refilling...</p>
                </template>
            </div>

        </div>

        </div>
        <!-- End Queue Selection View -->

    </main>

    <!-- Alpine.js App Logic -->
    <script>
        function lessonPlanApp() {
            return {
                data: {
                    masterLists: { knowledge: [], physical: [], songs: [] },
                    queues: { knowledge: [], physical: [], songs: [] },
                    completed: [],
                    development: [],
                    cycles: { knowledge: 1, physical: 1, songs: 1 },
                    version: '1.0'
                },
                showMenu: false,
                completedToday: [],
                currentView: 'queues',
                lessonContent: '',
                lessonLoading: false,
                lessonError: '',
                currentLessonTopic: null,
                isPlaying: false,
                darkMode: document.documentElement.classList.contains('dark'),

                toggleDarkMode() {
                    this.darkMode = !this.darkMode;
                    document.documentElement.classList.toggle('dark', this.darkMode);
                    localStorage.setItem('darkMode', this.darkMode);
                },

                async init() {
                    // Load data from localStorage or initial file
                    const savedData = localStorage.getItem('lessonPlanData');

                    if (savedData) {
                        this.data = JSON.parse(savedData);
                        console.log('‚úÖ Loaded data from localStorage');
                    } else {
                        // Load initial data from JSON file
                        try {
                            const response = await fetch('initial-data.json');
                            this.data = await response.json();
                            this.saveData();
                            console.log('‚úÖ Loaded initial data from file');
                        } catch (error) {
                            console.error('‚ùå Error loading initial data:', error);
                            alert('Error loading data. Please refresh the page.');
                        }
                    }

                    // Calculate completed today
                    const today = new Date().toISOString().split('T')[0];
                    this.completedToday = this.data.completed.filter(c => c.date === today);
                },

                saveData() {
                    localStorage.setItem('lessonPlanData', JSON.stringify(this.data));
                },

                getCurrentTopic(queueName) {
                    const queue = this.data.queues[queueName];
                    if (!queue || queue.length === 0) return null;

                    const topicId = queue[0];
                    return this.data.masterLists[queueName].find(t => t.id === topicId);
                },

                getQueuePosition(queueName) {
                    const queue = this.data.queues[queueName];
                    const total = this.data.masterLists[queueName].length;
                    const remaining = queue.length;
                    const current = total - remaining + 1;

                    return `${current} of ${total} (Cycle ${this.data.cycles[queueName]})`;
                },

                async selectTopic(queueName) {
                    const topic = this.getCurrentTopic(queueName);
                    if (!topic) return;

                    // Store topic info for lesson plan view
                    this.currentLessonTopic = { topic, queueName };

                    // Show lesson plan WITHOUT modifying queue
                    await this.showLessonPlan(topic.name, queueName);
                },

                markTopicComplete() {
                    if (!this.currentLessonTopic) return;

                    const { topic, queueName } = this.currentLessonTopic;

                    // Add to completed log
                    this.data.completed.push({
                        topicId: topic.id,
                        queue: queueName,
                        date: new Date().toISOString().split('T')[0],
                        topicName: topic.name
                    });

                    // Remove from queue
                    this.data.queues[queueName].shift();

                    // Check if queue is empty, refill if needed
                    if (this.data.queues[queueName].length === 0) {
                        this.refillQueue(queueName);
                    }

                    this.saveData();
                    this.updateCompletedToday();

                    // Close lesson and return to queue
                    this.closeLessonPlan();

                    // Show feedback
                    this.showNotification(`‚úì Marked complete: ${topic.name}`, 'success');
                },

                skipTopicFromLesson() {
                    if (!this.currentLessonTopic) return;

                    const { queueName } = this.currentLessonTopic;

                    // Move first item to end
                    const topicId = this.data.queues[queueName].shift();
                    this.data.queues[queueName].push(topicId);

                    this.saveData();

                    // Close lesson and return to queue
                    this.closeLessonPlan();

                    this.showNotification('‚è≠Ô∏è Topic skipped to end of queue', 'info');
                },

                async showLessonPlan(topicName, queueName) {
                    this.currentView = 'lesson';
                    this.lessonLoading = true;
                    this.lessonError = '';
                    this.lessonContent = '';

                    // Convert topic name to filename format
                    const filename = topicName
                        .toLowerCase()
                        .replace(/[^\w\s-]/g, ' ') // Replace special characters with space
                        .replace(/\s+/g, '-')      // Replace spaces with hyphens
                        .replace(/-+/g, '-')       // Replace multiple hyphens with single
                        .trim();

                    const filepath = `lessons/${queueName}/${filename}.md`;

                    try {
                        const response = await fetch(filepath);

                        if (!response.ok) {
                            throw new Error(`Lesson plan not found (${response.status})`);
                        }

                        const markdown = await response.text();

                        // Convert markdown to HTML using marked.js
                        this.lessonContent = marked.parse(markdown);
                        this.lessonLoading = false;

                    } catch (error) {
                        console.error('Error loading lesson plan:', error);
                        this.lessonError = `Could not load lesson plan: ${error.message}`;
                        this.lessonLoading = false;
                    }
                },

                closeLessonPlan() {
                    this.currentView = 'queues';
                    this.lessonContent = '';
                    this.lessonError = '';
                    this.currentLessonTopic = null;
                },

                skipTopic(queueName) {
                    const queue = this.data.queues[queueName];
                    if (queue.length === 0) return;

                    // Move first item to end
                    const topicId = queue.shift();
                    queue.push(topicId);

                    this.saveData();
                    this.showNotification('‚è≠Ô∏è Topic skipped to end of queue', 'info');
                },

                flagForDevelopment(queueName) {
                    const topic = this.getCurrentTopic(queueName);
                    if (!topic) return;

                    const reason = prompt('Why does this topic need work?', 'Needs revision');
                    if (reason === null) return; // User cancelled

                    // Add to development queue
                    this.data.development.push({
                        topicId: topic.id,
                        originalQueue: queueName,
                        reason: reason,
                        dateFlagged: new Date().toISOString().split('T')[0],
                        topicName: topic.name,
                        category: topic.category
                    });

                    // Remove from active queue
                    this.data.queues[queueName].shift();

                    // Check if queue is empty
                    if (this.data.queues[queueName].length === 0) {
                        this.refillQueue(queueName);
                    }

                    this.saveData();
                    this.showNotification(`üîß Moved to development queue: ${topic.name}`, 'warning');
                },

                refillQueue(queueName) {
                    // Get all topic IDs from master list
                    const allTopicIds = this.data.masterLists[queueName].map(t => t.id);

                    // Shuffle for randomization
                    const shuffled = [...allTopicIds].sort(() => Math.random() - 0.5);

                    // Refill queue
                    this.data.queues[queueName] = shuffled;

                    // Increment cycle
                    this.data.cycles[queueName]++;

                    console.log(`üîÑ Refilled ${queueName} queue (Cycle ${this.data.cycles[queueName]})`);
                    this.showNotification(`üéâ ${queueName.charAt(0).toUpperCase() + queueName.slice(1)} queue completed! Starting new cycle.`, 'success');
                },

                randomizeAllQueues() {
                    if (!confirm('üé≤ Randomize all queues?\n\nThis will shuffle the order of all topics in each queue.')) {
                        return;
                    }

                    ['knowledge', 'physical', 'songs'].forEach(queueName => {
                        // Shuffle current queue items (preserves which items are in queue)
                        const shuffled = [...this.data.queues[queueName]].sort(() => Math.random() - 0.5);
                        this.data.queues[queueName] = shuffled;
                    });

                    this.saveData();
                    this.showNotification('üé≤ All queues randomized!', 'success');
                },

                exportData() {
                    const dataStr = JSON.stringify(this.data, null, 2);
                    const blob = new Blob([dataStr], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    const date = new Date().toISOString().split('T')[0];
                    link.href = url;
                    link.download = `lesson-plan-data-${date}.json`;
                    link.click();
                    URL.revokeObjectURL(url);

                    this.showNotification('üì• Data exported successfully!', 'success');
                },

                importData(event) {
                    const file = event.target.files[0];
                    if (!file) return;

                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const imported = JSON.parse(e.target.result);

                            // Validate data structure
                            if (!imported.masterLists || !imported.queues || !imported.completed) {
                                throw new Error('Invalid data format');
                            }

                            // Confirm import
                            if (confirm('Import this data? This will replace all current data.')) {
                                this.data = imported;
                                this.saveData();
                                this.updateCompletedToday();
                                this.showNotification('üì§ Data imported successfully!', 'success');
                                window.location.reload();
                            }
                        } catch (error) {
                            console.error('Import error:', error);
                            alert('Error importing data. Please check the file format.');
                        }
                    };
                    reader.readAsText(file);
                },

                viewHistory() {
                    const total = this.data.completed.length;
                    const today = this.completedToday.length;
                    alert(`Completion History\n\nCompleted Today: ${today}\nTotal Completed: ${total}\n\nUse Export Data to save your full history.`);
                },

                viewDevelopment() {
                    const count = this.data.development.length;
                    if (count === 0) {
                        alert('Development Queue is empty!\n\nTopics flagged as "Needs Work" will appear here.');
                    } else {
                        const list = this.data.development.map((item, i) =>
                            `${i + 1}. ${item.topicName}\n   Reason: ${item.reason}`
                        ).join('\n\n');
                        alert(`Development Queue (${count} items)\n\n${list}\n\nUse Export Data to manage these items.`);
                    }
                },

                resetAllData() {
                    if (confirm('‚ö†Ô∏è Reset ALL data to initial state?\n\nThis will:\n- Clear all completed topics\n- Clear development queue\n- Reset all queues to beginning\n- Cannot be undone!')) {
                        if (confirm('Are you REALLY sure? This cannot be undone!')) {
                            localStorage.removeItem('lessonPlanData');
                            window.location.reload();
                        }
                    }
                },

                updateCompletedToday() {
                    const today = new Date().toISOString().split('T')[0];
                    this.completedToday = this.data.completed.filter(c => c.date === today);
                },

                showNotification(message, type) {
                    // Simple notification (could be enhanced with a toast library later)
                    console.log(`[${type.toUpperCase()}] ${message}`);
                    // Could add a toast notification here in the future
                },

                // Audio playback using TinyMusic
                audioContext: null,
                currentSequence: null,

                stopSong() {
                    if (this.currentSequence) {
                        this.currentSequence.stop();
                        this.isPlaying = false;
                        this.showNotification('üîá Stopped playback', 'info');
                    }
                },

                playSongMelody() {
                    // If already playing, stop
                    if (this.isPlaying) {
                        this.stopSong();
                        return;
                    }

                    // Get the current song's melody data
                    if (!this.currentLessonTopic || this.currentLessonTopic.queueName !== 'songs') {
                        console.log('Not a song');
                        return;
                    }

                    const topic = this.currentLessonTopic.topic;
                    if (!topic.melody || !topic.melody.length) {
                        this.showNotification('No melody data for this song', 'warning');
                        return;
                    }

                    // Initialize AudioContext on first user interaction
                    if (!this.audioContext) {
                        this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    }

                    // Stop any currently playing sequence
                    if (this.currentSequence) {
                        this.currentSequence.stop();
                    }

                    // Create sequence with the song's tempo (default to 100 BPM)
                    const tempo = topic.tempo || 100;
                    this.currentSequence = new TinyMusic.Sequence(this.audioContext, tempo, topic.melody);

                    // Configure playback
                    this.currentSequence.loop = false;
                    this.currentSequence.staccato = 0.1;
                    this.currentSequence.gain.gain.value = 0.3;

                    // Play the melody
                    this.isPlaying = true;
                    this.currentSequence.play();
                    this.showNotification(`üéµ Playing ${topic.name}...`, 'info');

                    // Calculate duration and auto-stop isPlaying flag
                    // Rough estimate: each quarter note at 100 BPM = 0.6 seconds
                    const noteDurations = { 'w': 4, 'h': 2, 'q': 1, 'e': 0.5 };
                    let totalBeats = 0;
                    topic.melody.forEach(note => {
                        const duration = note.split(' ')[1] || 'q';
                        totalBeats += noteDurations[duration] || 1;
                    });
                    const durationMs = (totalBeats * 60 / tempo) * 1000 + 500; // Add buffer

                    setTimeout(() => {
                        this.isPlaying = false;
                    }, durationMs);

                    console.log(`üéµ Playing ${topic.name} (${topic.melody.length} notes, ~${Math.round(durationMs/1000)}s)`);
                }
            };
        }

        // Register service worker for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(reg => console.log('‚úÖ Service Worker registered'))
                    .catch(err => console.log('‚ùå Service Worker registration failed:', err));
            });
        }
    </script>

</body>
</html>
